stages:
  - checkout
  - build_frontend
  - build_backend
  - deploy

variables:
  FRONT_DIR: "frontend"
  BACK_DIR: "back"
  COMPOSE_FILE: "docker-compose.yml"

# Checkout code
checkout_code:
  stage: checkout
  script:
    - echo "ğŸ“¥ Checking out the project..."
    - echo "Code is already checked out by GitLab Runner."

# Build Angular Frontend
build_angular_frontend:
  stage: build_frontend
  script:
    - echo "ğŸ“¦ Installing dependencies and building Angular app..."
    - cd $FRONT_DIR
    - npm install --legacy-peer-deps
    - npm run build -- --configuration=production
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 1 week
  cache:
    paths:
      - frontend/node_modules/

# Build Backend (example if applicable)
build_backend:
  stage: build_backend
  script:
    - echo "ğŸ”§ Installing backend dependencies..."
    - cd $BACK_DIR
    - npm install --legacy-peer-deps # Or use a build tool for your back-end if needed
  artifacts:
    paths:
      - back/dist/  # If applicable
    expire_in: 1 week
  cache:
    paths:
      - back/node_modules/

# Deploy with Docker Compose
docker_compose_up:
  stage: deploy
  script:
    - echo "ğŸ³ Stopping existing containers (if any)..."
    - sudo docker-compose -f $COMPOSE_FILE down || true
    - echo "ğŸ³ Building Docker images..."
    - sudo docker-compose -f $COMPOSE_FILE build
    - echo "ğŸ³ Starting containers..."
    - sudo docker-compose -f $COMPOSE_FILE up -d
  when: on_success
